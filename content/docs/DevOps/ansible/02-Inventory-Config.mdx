---
title: "Inventory 资产管理深度剖析"
description: "解析 Ansible 资产清单的高级定义、变量覆盖优先级、动态资产源以及 Inventory 插件机制."
---

Inventory 不仅仅是一个主机 IP 列表, 它是 Ansible 的 "资源拓扑图". 专家级运维需要利用其层级化和动态化的特性, 将成千上万的服务器按业务逻辑进行管理.

## 1. 资产清单的逻辑分层

### 1.1 分组嵌套 (Groups of Groups)
在大型数据中心, 我们需要按照地理位置、环境和应用类型进行多维映射:

```ini
[office_bj]
10.1.1.10
10.1.1.11

[office_sh]
10.2.1.10

[china_offices:children]
office_bj
office_sh

[production:children]
china_offices
```

### 1.2 变量优先级与覆盖原则
Ansible 的变量采用 "深度优先" 和 "特定性优先" 的覆盖逻辑. 

1.  **Host Variables (最高项)**: `nodes01.example.com http_port=80`.
2.  **Group Variables (子组)**: 子组变量会覆盖父组变量.
3.  **all 组变量 (最小项)**: 全局生效的默认设置.

---

## 2. 外部资产管理: 动态 Inventory

在云原生时代, 手动维护 IP 列表是不现实的.

### 2.1 Inventory 插件 (推荐方式)
现代 Ansible 推荐使用特定的插件 (如 `aws_ec2`, `azure_rm`) 实时查询云接口.
*   **实时性**: 自动发现刚拉起或释放的虚拟机.
*   **标签筛选**: 根据云平台的 Tag (如 `Env=Prod`) 自动归类到 Ansible 组中.

### 2.2 目录化 Inventory
Ansible 支持在一个目录下存放多个清单文件. 
*   **应用场景**: 将静态 `hosts` 文件与多个云平台的 `.yml` 插件配置放在同一目录下, 运行任务时通过 `-i inventory/` 指向该目录, Ansible 会自动将其合并.

---

## 3. 组织最佳实践: Variable Directory

为了保持 Inventory 文件的简洁, 建议使用独立的变量目录:

*   **`group_vars/`**: 目录下创建与组名对应的 YAML 文件 (如 `web_servers.yml`).
*   **`host_vars/`**: 目录下创建与主机名对应的 YAML 文件.

Ansible 在执行时会自动搜索并在运行目录下加载这些变量.

---

## 4. 关键技巧: 判断与筛选

*   **匹配排除**: `ansible "web_servers:!db_servers" -m ping` (属于 web 但不属于 db 的主机).
*   **交集匹配**: `ansible "web_servers:&bj" -m ping` (同时属于 web 和北京组的主机).

> 优秀的资产管理体系应该做到 "逻辑清晰、自动发现、无须手工维护 IP". 精通主机变量与组变量的层级覆盖, 是构建高复用性 Playbook 的第一步.
