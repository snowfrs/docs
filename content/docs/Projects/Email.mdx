---
title: "E-mail"
---
# E-mail
* ä¸è¦å¿½è§†E-mailæœåŠ¡å¯¹æ€§èƒ½çš„éœ€æ±‚
* ä¸è¦å¿½è§†E-mailæœåŠ¡å¯¹å­˜å‚¨çš„éœ€æ±‚
* E-mailæœåŠ¡è¿œæ¯”æˆ‘ä»¬è®¤ä¸ºçš„å¤æ‚

IMAP + SMTP + CalDAV + CardDAV
Cyrus IMAP + JMAP + EAS Gateway(z-push.org or SOGo), we choose SOGo.

You'll be setting up a groupware mail stack with:

Cyrus IMAP â€” handles IMAP, LMTP, sieve filters, and JMAP.

Postfix â€” SMTP in/out.

nginx â€” TLS reverse proxy for HTTPS and JMAP.

Let's Encrypt / Certbot â€” SSL certificates.

DNS â€” MX, SPF, DKIM, DMARC records.
 - MX, Mail Exchange
 - SPF, Sender Policy Framework
 - DKIM, DomainKeys Identified Mail
 - DMARC, Domain-based Message Authentication, Reporting, and Conformance

Optional â€” Sieve for filtering, SpamAssassin + ClamAV for anti-spam/virus, and PostgreSQL for auth/meta.

Feature list:

1. Intergated with AD

2. IMAP + SMTP + CalDAV + CardDAV + JMAP + Sieve + EAS

3. Multi-domain, Domain aliases support

4. Plus Addressing/Sub-addressing support

5. automatically backup all send/receive mail to a shadow mailbox, called shadow@mydomain.com

6. Monitoring and statistically mail traffic, for analyze data

7. Welcom letter for new user(from template html + systemd-timer).

8. Disclaimer and Signature (with AD Lookup). (éƒ¨åˆ†å®ç°, è¦†ç›–100%åœºæ™¯å…¨å¼ºåˆ¶ä¸ç°å®)

9. åŒºåˆ†å®ä¹ ç”Ÿå’Œæ­£å¼å‘˜å·¥, å®ä¹ ç”Ÿåªèƒ½å‘å†…éƒ¨é‚®ä»¶

10. Intergated with PMG(Gatekeeper), ç—…æ¯’æŸ¥æ€, åƒåœ¾æ‹¦æˆª, æµé‡ç»Ÿè®¡, å®¡è®¡.




Let's go step by step for Cyrus + Postfix + SOGo (EAS + CalDAV + CardDAV + Webmail) â€” with a visual architecture summary at the end.

ğŸ§± Architecture Overview
```
ğŸ“± Mobile/Outlook Clients
    â”‚
    â”‚ HTTPS (ActiveSync, JMAP, Web)
    â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Nginx   â”‚ â† TLS termination + proxy
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   SOGo   â”‚ â† Webmail, CalDAV, CardDAV, EAS gateway
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Cyrus IMAP (Mail, JMAP, Cal/CardDAV) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Postfix   â”‚ â† SMTP in/out, DKIM, spam filters
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

```mermaid
graph TD
  Client_Mail["é‚®ä»¶å®¢æˆ·ç«¯ (Outlook/Apple)"] --> |SMTP 587/465| Postfix
  Client_Web[Webæµè§ˆå™¨] -->|HTTPS 443| Nginx
  Client_Mobile["æ‰‹æœº (iOS/Android)"] -->|ActiveSync| Nginx

  subgraph "Mail Server Stack"
    Nginx -->|Proxy /SOGo| SOGo
    Nginx -->|Proxy /jmap| Cyrus((Cyrus IMAP))
    
    Postfix -->|LMTP Socket| Cyrus
    Postfix -->|SQL Auth/Lookup| DB[(PostgreSQL)]
    
    Cyrus -->|Read/Write Mail| Storage[Mail Storage]
    Cyrus -->|SQL Auth| DB
    
    SOGo -->|IMAP/SMTP| Local_Loop[Localhost]
    SOGo -->|SQL Contacts/Cal| DB
    
    Local_Loop --> Postfix
    Local_Loop --> Cyrus
  end
```

æ›´æ–°åçš„æ¶æ„
```mermaid
graph TD
  %% --- External World ---
  subgraph "Public Internet"
    External_Senders["å¤–éƒ¨å‘ä»¶äºº<br />(Gmail/Outlook)"]
    Roaming_Users["ç§»åŠ¨/æ¡Œé¢ç”¨æˆ·<br />(æ‰‹æœº/PC)"]
  end

  %% --- Cloud Infrastructure ---
  subgraph "Cloud VPS (Backup MX)"
    PMG["Proxmox Mail Gateway<br />(MX Priority 20)"]
    note_pmg[åŠŸèƒ½: æ€æ¯’/ååƒåœ¾/ç»´æŠ¤æœŸç¼“å­˜é˜Ÿåˆ—]
  end

  %% --- Local IDC ---
  subgraph "Local IDC (Trusted Network)"
    
    %% Entry Points
    Firewall[é˜²ç«å¢™/è·¯ç”±æ˜ å°„]
    Nginx["Nginx Reverse Proxy<br />(SSL Offloading)"]
    
    %% Mail Core
    Postfix["Postfix MTA<br />(SMTP/Routing/BCC)"]
    Cyrus["Cyrus IMAP<br />(Storage/JMAP/Sieve)"]
    
    %% Groupware & DB
    SOGo["SOGo Groupware<br />(Webmail/EAS/CalDAV)"]
    Postgres[(PostgreSQL)]
    
    %% Identity
    AD["Active Directory<br />(User Auth/Aliases)"]
    
    %% Automation
    Welcome_Script["Python Welcome Script<br />(Crontab)"]
    
    %% Storage Logic
    Shadow_Mailbox["Shadow Mailbox<br />(Audit/Archive)"]
    User_Mailbox[User Mailboxes]
  end

  %% --- Connections: Incoming Mail Flow ---
  External_Senders -- "1. æ­£å¸¸æŠ•é€’ (MX 10)" --> Firewall
  External_Senders -- "2. IDCæ–­ç½‘æ—¶ (MX 20)" --> PMG
  PMG -.-> |"3. ç»´æŠ¤ç»“æŸè‡ªåŠ¨å›ä¼  (SMTP)"| Firewall
  
  Firewall -- "Port 25 (SMTP)" --> Postfix
  Firewall -- "Port 443 (HTTPS)" --> Nginx
  
  %% --- Connections: User Access ---
  Roaming_Users -- "HTTPS (ActiveSync/JMAP)" --> Nginx
  Roaming_Users -- "IMAP/SMTP (TLS)" --> Firewall

  %% --- Connections: Internal Logic ---
  Nginx -- "Proxy /SOGo" --> SOGo
  Nginx -- "Proxy /jmap" --> Cyrus
  
  SOGo -- "IMAP/SMTP" --> Postfix
  SOGo -- "Contacts/Cal Data" --> Postgres
  
  Postfix -- "LMTP (Socket)" --> Cyrus
  Cyrus -- "Read/Write" --> User_Mailbox

  %% --- Connections: The Specific Requirements ---
  
  %% 1. Shadow Copy Logic
  Postfix -- "Always BCC (Copy)" --> Cyrus
  Cyrus -- "Deliver" --> Shadow_Mailbox
  
  %% 2. AD Integration (LDAP)
  Postfix -.-> |"Query Aliases/Recipients"| AD
  Cyrus -.-> |"SASL Auth (Password)"| AD
  SOGo -.-> |"Auth & Global Address Book"| AD
  
  %% 3. Welcome Script Logic
  Welcome_Script -.-> |"1. Query New Users"| AD
  Welcome_Script -- "2. Send Email (SMTP)" --> Postfix
  Postfix -- "3. Trigger Mailbox Creation" --> Cyrus
```

å†æ¬¡æ›´æ–°æ¶æ„
```mermaid
graph TD
  %% --- æ ·å¼å®šä¹‰ (Styling) ---
  classDef public fill:#f4f4f4,stroke:#666,stroke-width:1px,color:#333;
  classDef gateway fill:#ff9800,stroke:#e65100,stroke-width:3px,color:white,font-weight:bold;
  classDef internal fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1;
  classDef storage fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#333;
  classDef firewall fill:#607d8b,stroke:#37474f,stroke-width:2px,color:white;

  %% --- å¤–éƒ¨åŒºåŸŸ (External) ---
  subgraph "Public Internet"
    direction TB
    Ext_Senders["External Senders<br />(Gmail / Outlook)"]:::public
    Ext_Receivers["External Receivers"]:::public
    Roaming_Users["Roaming Users<br />(Mobile / Laptop)"]:::public
  end

  %% --- æœ¬åœ° IDC æœºæˆ¿ (Local IDC) ---
  subgraph "Local IDC Infrastructure"
    direction TB
    
    %% è¾¹ç•Œå±‚
    FW["ğŸ”¥ Firewall / Router<br />(NAT Mapping)"]:::firewall

    %% æ ¸å¿ƒç½‘å…³å±‚ (The Gatekeeper)
    PMG{{"ğŸ›¡ï¸ Proxmox Mail Gateway<br />(Anti-Spam / Anti-Virus / Stats)"}}:::gateway

    %% å†…éƒ¨ä¿¡ä»»ç½‘ç»œ (Internal Trust Zone)
    subgraph "Trusted Internal Network"
      direction TB
      
      %% æ¥å…¥å±‚
      Nginx["Nginx Proxy<br />(SSL Offloading / JMAP)"]:::internal
      
      %% é‚®ä»¶æ ¸å¿ƒ (MTA & Storage)
      Postfix["Postfix MTA<br />(Internal Routing / Shadow Copy)"]:::internal
      Cyrus["Cyrus IMAP<br />(Mail Storage / JMAP Core)"]:::storage
      
      %% åä½œä¸æ•°æ®
      SOGo["SOGo Groupware<br />(Webmail / ActiveSync)"]:::internal
      DB[("PostgreSQL<br />(Contacts / Calendars)")]:::storage
      
      %% èº«ä»½ä¸è‡ªåŠ¨åŒ–
      AD["Active Directory (AD)<br />(User Auth / Groups)"]:::storage
      Scripts["Python Automation<br />(Welcome Mail / Sync Rules)"]:::internal
    end
  end

  %% ================= è¿çº¿é€»è¾‘ (Connections) =================

  %% --- 1. å…¥ç«™é‚®ä»¶æµ (Inbound: Red Lines) ---
  %% å¤–éƒ¨ -> é˜²ç«å¢™ -> PMG -> Postfix -> Cyrus
  Ext_Senders -- "1. SMTP (Port 25)" --> FW
  FW -- "2. Port Forward (Int IP)" --> PMG
  PMG -- "3. Clean Mail (Scan OK)" --> Postfix
  Postfix -- "4. LMTP Delivery" --> Cyrus
  linkStyle 0,1,2,3 stroke:#d32f2f,stroke-width:2px;

  %% --- 2. å‡ºç«™é‚®ä»¶æµ (Outbound: Blue Lines) ---
  %% å†…éƒ¨ -> Postfix -> PMG -> é˜²ç«å¢™ -> å¤–éƒ¨
  SOGo -- "1. User Send" --> Postfix
  Scripts -- "1. Auto Send" --> Postfix
  Postfix -- "2. Relay Host (All Traffic)" --> PMG
  PMG -- "3. Signed & Scanned" --> FW
  FW -- "4. Deliver to Internet" --> Ext_Receivers
  linkStyle 4,5,6,7,8 stroke:#1976d2,stroke-width:2px;

  %% --- 3. ç”¨æˆ·è®¿é—®æµ (Access: Green Lines) ---
  Roaming_Users -- "HTTPS (443)" --> FW
  FW -- "Forward" --> Nginx
  Nginx -- "Proxy /SOGo" --> SOGo
  Nginx -- "Proxy /jmap" --> Cyrus
  linkStyle 9,10,11,12 stroke:#388e3c,stroke-width:2px;

  %% --- 4. å†…éƒ¨é›†æˆä¸å®¡è®¡ (Internal Logic: Dotted Lines) ---
  %% èº«ä»½è®¤è¯
  PMG -.-> |"LDAP (Block Interns)"| AD
  Postfix -.-> |"LDAP (Verify Users)"| AD
  SOGo -.-> |"Auth"| AD
  
  %% å®¡è®¡å½’æ¡£ (Shadow Copy)
  Postfix -.-> |"Always BCC (Hidden)"| Cyrus
  
  %% æ•°æ®åº“
  SOGo --- DB
```

è¦æ±‚é€šä¿¡åŠ å¯†
```mermaid
graph TD
  %% --- æ ·å¼å®šä¹‰ (Styling) ---
  classDef public fill:#f4f4f4,stroke:#666,stroke-width:1px,color:#333;
  classDef gateway fill:#ff9800,stroke:#e65100,stroke-width:3px,color:white,font-weight:bold;
  classDef internal fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#0d47a1;
  classDef storage fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#333;
  classDef firewall fill:#607d8b,stroke:#37474f,stroke-width:2px,color:white;

  %% --- å¤–éƒ¨åŒºåŸŸ (External) ---
  subgraph "Public Internet"
    direction TB
    Ext_Senders["External MTAs<br />(Gmail / Outlook)"]:::public
    Ext_Receivers["External Receivers"]:::public
    Roaming_Users["Roaming Users<br />(Mobile / Laptop)"]:::public
  end

  %% --- æœ¬åœ° IDC æœºæˆ¿ (Local IDC) ---
  subgraph "Local IDC Infrastructure"
    direction TB
    
    %% è¾¹ç•Œå±‚
    FW["ğŸ”¥ Firewall / Router<br />(Port Mapping & SSL Termination)"]:::firewall

    %% æ ¸å¿ƒç½‘å…³å±‚ (The Gatekeeper)
    PMG{{"ğŸ›¡ï¸ Proxmox Mail Gateway<br />(Enforced TLS / Anti-Virus)"}}:::gateway

    %% å†…éƒ¨ä¿¡ä»»ç½‘ç»œ (Internal Trust Zone)
    subgraph "Trusted Internal Network"
      direction TB
      
      %% æ¥å…¥å±‚
      Nginx["Nginx Proxy<br />(Port 443 Only)"]:::internal
      
      %% é‚®ä»¶æ ¸å¿ƒ (MTA & Storage)
      Postfix["Postfix MTA<br />(TLS Enabled)"]:::internal
      Cyrus["Cyrus IMAP<br />(IMAPS / JMAP)"]:::storage
      
      %% åä½œä¸æ•°æ®
      SOGo["SOGo Groupware"]:::internal
      DB[("PostgreSQL")]:::storage
      AD["Active Directory"]:::storage
      Scripts["Python Automation"]:::internal
    end
  end

  %% ================= è¿çº¿é€»è¾‘ (Connections) =================

  %% --- 1. å…¥ç«™é‚®ä»¶æµ (Inbound: Red Lines) ---
  %% å¤–éƒ¨ MTA -> é˜²ç«å¢™ -> PMG -> Postfix -> Cyrus
  Ext_Senders -- "SMTP 25 (STARTTLS Encrypted)" --> FW
  FW -- "Forward (TLS)" --> PMG
  PMG -- "Internal Relay (TLS)" --> Postfix
  Postfix -- "LMTP (Secure Socket)" --> Cyrus
  linkStyle 0,1,2,3 stroke:#d32f2f,stroke-width:2px;

  %% --- 2. å‡ºç«™é‚®ä»¶æµ (Outbound: Blue Lines) ---
  %% å†…éƒ¨ -> Postfix -> PMG -> é˜²ç«å¢™ -> å¤–éƒ¨
  SOGo -- "Submission (587 TLS)" --> Postfix
  Scripts -- "Submission (587 TLS)" --> Postfix
  Postfix -- "Relay Host (TLS)" --> PMG
  PMG -- "SMTP 25 (STARTTLS Enforced)" --> FW
  FW -- "Deliver to Internet (TLS)" --> Ext_Receivers
  linkStyle 4,5,6,7,8 stroke:#1976d2,stroke-width:2px;

  %% --- 3. å®¢æˆ·ç«¯åŠ å¯†è®¿é—®æµ (Secure Client Access: Green Lines) ---
  %% æ¼«æ¸¸ç”¨æˆ· -> é˜²ç«å¢™ (åŠ å¯†ç«¯å£)
  Roaming_Users -- "SMTPS (465) / Submission (587)" --> FW
  Roaming_Users -- "IMAPS (993) / HTTPS (443)" --> FW
  
  %% é˜²ç«å¢™åˆ†å‘
  FW -- "Forward (443)" --> Nginx
  FW -- "Forward (993/465)" --> Postfix
  
  %% å†…éƒ¨è½¬å‘
  Nginx -- "Proxy (TLS/Local)" --> SOGo
  Nginx -- "Proxy (TLS/Local)" --> Cyrus
  linkStyle 9,10,11,12,13,14 stroke:#388e3c,stroke-width:2px;

  %% --- 4. å†…éƒ¨é›†æˆ (Dotted Lines) ---
  PMG -.-> |"LDAPS (Secure 636)"| AD
  Postfix -.-> |"LDAPS (Secure 636)"| AD
  SOGo -.-> |"LDAPS (Secure 636)"| AD
  SOGo --- DB
```

æ›´æ–°
1. MTA æµé‡ (Port 25): å¼ºåˆ¶ç»è¿‡ PMG æ¸…æ´—. 

2. å®¢æˆ·ç«¯æµé‡ (Port 465/587/993): ç»•è¿‡ PMG, ç›´è¾¾ Postfix/Cyrus è¿›è¡Œ SASL è®¤è¯ (å› ä¸º PMG é€šå¸¸ä¸å¤„ç†ç»ˆç«¯ç”¨æˆ·è®¤è¯) , ä½†å‘å‡ºçš„é‚®ä»¶ä¼šå›æµç»™ PMG ç­¾å. 

3. å…¨é“¾è·¯åŠ å¯†: æ˜ç¡®æ ‡æ³¨äº† STARTTLS, SMTPS, IMAPS, LDAPS. 

```mermaid
flowchart TD
  %% ================= æ ·å¼å®šä¹‰ (Styling) =================
  classDef external fill:#f8f9fa,stroke:#999,stroke-width:1px,stroke-dasharray: 5 5;
  classDef edge fill:#fff3e0,stroke:#e65100,stroke-width:2px;
  classDef secure fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
  classDef storage fill:#eceff1,stroke:#455a64,stroke-width:2px;
  
  %% ================= å¤–éƒ¨ä¸–ç•Œ (Internet) =================
  subgraph Internet ["â˜ï¸ Public Internet (Untrusted)"]
    direction TB
    External_MTA("ğŸŒ External MTAs<br />(Gmail/Outlook)"):::external
    Roaming_Client("ğŸ“± Roaming Clients<br />(Outlook/iPhone)"):::external
  end

  %% ================= è¾¹ç•Œé˜²æŠ¤å±‚ (Edge / DMZ) =================
  subgraph Edge_Layer ["ğŸ”’ Edge Security Zone (DMZ)"]
    direction TB
    Firewall("ğŸ”¥ Firewall / NAT<br />(Ports: 25, 443, 465, 587, 993)"):::edge
    PMG("ğŸ›¡ï¸ Proxmox Mail Gateway<br />(MTA Traffic Filter)"):::edge
  end

  %% ================= å†…éƒ¨æ ¸å¿ƒå±‚ (Internal) =================
  subgraph Internal_LAN ["ğŸ¢ Trusted Internal LAN"]
    direction TB
    
    %% ä»£ç†ä¸è·¯ç”±
    Nginx("ğŸŒ Nginx Proxy<br />(Webmail / JMAP)"):::secure
    Postfix("xx Postfix MTA<br />(SASL Auth / Routing)"):::secure
    
    %% å­˜å‚¨ä¸ä¸šåŠ¡
    Cyrus("mailbox Cyrus IMAP<br />(Mail Store)"):::storage
    SOGo("ğŸ“… SOGo Groupware<br />(Contacts / Cal)"):::storage
    
    %% èº«ä»½æº
    AD("ğŸ”‘ Active Directory<br />(Identity Source)"):::storage
  end

  %% ================= 1. æ”¶ä¿¡é“¾è·¯ (MTA Incoming) =================
  %% å¤–éƒ¨ MTA -> é˜²ç«å¢™ -> PMG -> Postfix -> Cyrus
  External_MTA == "SMTP 25 (STARTTLS)" ==> Firewall
  Firewall == "NAT to PMG" ==> PMG
  PMG == "Clean Mail (TLS)" ==> Postfix
  Postfix -.->|"LMTP (Local)"| Cyrus
  linkStyle 0,1,2,3 stroke:#d32f2f,stroke-width:3px;

  %% ================= 2. å®¢æˆ·ç«¯å‘ä¿¡é“¾è·¯ (Client Submission) =================
  %% å®¢æˆ·ç«¯ -> é˜²ç«å¢™ -> Postfix (è®¤è¯) -> PMG (ç­¾å/æ‰«æ) -> Internet
  Roaming_Client -- "SMTPS 465 / Submission 587" --> Firewall
  Firewall -- "NAT to Postfix" --> Postfix
  Postfix -- "Relay (TLS)" --> PMG
  PMG -- "SMTP 25 (Signed)" --> Firewall
  Firewall -- "Send" --> Internet
  linkStyle 4,5,6,7,8 stroke:#1565c0,stroke-width:2px;

  %% ================= 3. å®¢æˆ·ç«¯æ”¶ä¿¡ä¸è®¿é—® (Client Access) =================
  %% å®¢æˆ·ç«¯è¯»å–é‚®ä»¶ (IMAPS) å’Œ Webmail (HTTPS)
  Roaming_Client -- "IMAPS 993 / HTTPS 443" --> Firewall
  Firewall -- "NAT to Nginx" --> Nginx
  Firewall -- "NAT to Cyrus" --> Cyrus
  Nginx -- "Proxy" --> SOGo
  linkStyle 9,10,11,12 stroke:#2e7d32,stroke-width:2px;

  %% ================= 4. å†…éƒ¨è®¤è¯é“¾è·¯ (LDAPS) =================
  PMG -.-> |"LDAPS 636"| AD
  Postfix -.-> |"LDAPS 636"| AD
  SOGo -.-> |"LDAPS 636"| AD
  Cyrus -.-> |"SASL -> LDAPS"| AD
  linkStyle 13,14,15,16 stroke:#607d8b,stroke-width:1px,stroke-dasharray: 3 3;
```

æœ€æ–°æ¶æ„

**é£é™©**
æœ¬åœ°éƒ¨ç½²E-mailæœåŠ¡çš„æœ€å¤§é£é™©å¹¶éæœåŠ¡æœ¬èº«å‡ºé—®é¢˜å¯¼è‡´ä¸å¯ç”¨, è€Œæ˜¯è¢«å…¨çƒå„å¤§mail provideræ‹¦æˆªç”šè‡³åŠ å…¥é»‘åå•. [MXTOolbox Blacklist Check](https://mxtoolbox.com/blacklists.aspx)

æˆªæ­¢2025.11.24çš„ç²¾ç¡®ç»Ÿè®¡
é‚®ä»¶æ•°æ®å¤§äº2Gçš„ç”¨æˆ·æœ‰108ä¸ª, å æ€»äººæ•°44.1%. è¿™äº›ç”¨æˆ·åˆè®¡å…±4330888å°é‚®ä»¶, å­˜å‚¨é‡ 1044.2G.
ä¾æ®æ­¤ç²¾ç¡®æ•°æ®é¢„ä¼°
é¢„ä¼°æ€»é‚®ä»¶æ•°é‡ 600ä¸‡å°, å­˜å‚¨é‡ 1.5T.

éœ€è€ƒè™‘çš„é—®é¢˜: 
å½“å‰å“ªäº›æœåŠ¡é›†æˆäº†é‚®ä»¶æœåŠ¡? è¯¥å¦‚ä½•å¤„ç†

æ¶æ„å›¾äº®ç‚¹: 
- ğŸŸ£ ç´«è‰²è™šçº¿åŒºåŸŸ (Feature Zone): ä¸“é—¨å±•ç¤ºäº†ä½ è¦æ±‚çš„"é™é»˜å½’æ¡£ (Shadow Copy)"å’Œ"è‡ªåŠ¨åŒ–æ¬¢è¿è„šæœ¬". 
- ğŸ”´ çº¢è‰²æµ (Inbound): å¤–éƒ¨é‚®ä»¶å¦‚ä½•ç»è¿‡ PMG æ¸…æ´—åè¿›å…¥å†…éƒ¨. 
- ğŸ”µ è“è‰²æµ (Outbound): å†…éƒ¨å‘ä¿¡å¦‚ä½•ç»è¿‡ Postfix è®¤è¯, å†è½¬ç»™ PMG ç­¾åå‡ºç½‘. 
- ğŸŸ¢ ç»¿è‰²æµ (Access): ç”¨æˆ·å¦‚ä½•å®‰å…¨è¯»å–é‚®ä»¶. 

```mermaid
flowchart TD
  %% ================= æ ·å¼å®šä¹‰ (Styling) =================
  classDef public fill:#f5f5f5,stroke:#999,stroke-width:1px,color:#333;
  classDef firewall fill:#455a64,stroke:#263238,stroke-width:2px,color:#fff;
  classDef pmg fill:#ff9800,stroke:#e65100,stroke-width:3px,color:#fff,font-weight:bold;
  classDef core fill:#2196f3,stroke:#0d47a1,stroke-width:2px,color:#fff;
  classDef storage fill:#4caf50,stroke:#1b5e20,stroke-width:2px,color:#fff;
  classDef feature fill:#9c27b0,stroke:#4a148c,stroke-width:2px,stroke-dasharray: 5 5,color:#fff;

  %% ================= 1. å¤–éƒ¨ä¸–ç•Œ (Public Internet) =================
  subgraph Internet ["â˜ï¸ Public Internet"]
    direction TB
    Sender("ğŸŒ External Senders<br />(Gmail/Outlook)"):::public
    Roaming("ğŸ“± Roaming User<br />(Client App)"):::public
  end

  %% ================= 2. è¾¹ç•Œå±‚ (Edge / DMZ) =================
  subgraph DMZ ["ğŸ”’ Local IDC Edge"]
    FW("ğŸ”¥ Firewall / NAT Router<br />[Ports: 25, 465, 587, 993, 443]"):::firewall
    PMG("ğŸ›¡ï¸ Proxmox Mail Gateway<br />[Anti-Spam | Anti-Virus | Stats]"):::pmg
  end

  %% ================= 3. å†…éƒ¨æ ¸å¿ƒå±‚ (Trusted LAN) =================
  subgraph LAN ["ğŸ¢ Internal Trusted Network"]
    direction TB
    
    %% æ ¸å¿ƒæœåŠ¡
    Nginx("ğŸŒ Nginx Proxy<br />(SSL Offloading)"):::core
    Postfix("ğŸ“® Postfix MTA<br />(Routing & Auth)"):::core
    
    %% å­˜å‚¨æœåŠ¡
    subgraph Cyrus_Cluster ["ğŸ“¦ Cyrus IMAP Server"]
      direction TB
      User_Box("User Mailboxes<br />(INBOX)"):::storage
      Shadow_Box("ğŸ—„ï¸ Shadow Archive<br />(Audit Copy)"):::feature
    end
    
    SOGo("ğŸ“… SOGo Groupware"):::storage
    AD("ğŸ”‘ Active Directory"):::storage

    %% ç‰¹æ€§æœåŠ¡ (Features)
    Welcome_Bot("ğŸ¤– Python Welcome Bot<br />(Auto-Send Script)"):::feature
  end

  %% ================= 4. è¿çº¿é€»è¾‘ (Traffic Flows) =================

  %% --- A. å…¥ç«™æµ (Inbound - Red) ---
  %% å¤–éƒ¨ -> PMG -> Postfix -> User Mailbox
  Sender == "SMTP 25 (TLS)" ==> FW
  FW == "NAT to PMG" ==> PMG
  PMG == "Clean Mail (25)" ==> Postfix
  Postfix == "LMTP Delivery" ==> User_Box
  linkStyle 0,1,2,3 stroke:#f44336,stroke-width:3px;

  %% --- B. å‡ºç«™æµ (Outbound - Blue) ---
  %% ç”¨æˆ·/è„šæœ¬ -> Postfix -> PMG -> å¤–éƒ¨
  Roaming -- "SMTPS 465 / Sub 587" --> FW
  FW -- "NAT to Postfix" --> Postfix
  Welcome_Bot -- "SMTP (Local)" --> Postfix
  SOGo -- "SMTP (Local)" --> Postfix
  
  Postfix -- "Relay for DKIM/Scan" --> PMG
  PMG -- "SMTP 25 (Signed)" --> FW
  FW -- "Send to Internet" --> Internet
  linkStyle 4,5,6,7,8,9,10 stroke:#2196f3,stroke-width:2px;

  %% --- C. ç‰¹æ€§æµ: é‚®ä»¶å½’æ¡£ (Feature - Purple) ---
  %% åªè¦ç»è¿‡ Postfix, éƒ½ä¼šåˆ†å‰ä¸€ä»½åˆ° Shadow Box
  Postfix -.-> |"ğŸŸ£ Always BCC (Transparent)"| Shadow_Box
  linkStyle 11 stroke:#9c27b0,stroke-width:2px,stroke-dasharray: 5 5;

  %% --- D. è®¿é—®æµ: è¯»ä¿¡ä¸ç½‘é¡µ (Access - Green) ---
  Roaming -- "IMAPS 993 / HTTPS 443" --> FW
  FW -- "NAT" --> Nginx
  FW -- "NAT" --> User_Box
  Nginx --> SOGo
  Nginx --> User_Box
  linkStyle 12,13,14,15,16 stroke:#4caf50,stroke-width:2px;

  %% --- E. è®¤è¯æµ (Auth - Grey) ---
  Postfix -.-> AD
  PMG -.-> AD
  SOGo -.-> AD
  Welcome_Bot -.-> AD
```




âš™ï¸ Step 2 â€” Connect SOGo to Cyrus IMAP + Postfix
sogo.conf
```
{
 "WOWorkersCount": 10,
 "SOGoIMAPServer": "imaps://127.0.0.1:993",
 "SOGoSMTPServer": "127.0.0.1",
 "SOGoMailDomain": "yourdomain.com",
 "SOGoSieveServer": "sieve://127.0.0.1:4190",
 "SOGoMailingMechanism": "smtp",
 "SOGoUserSources": [
  {
   "type": "sql",
   "id": "directory",
   "viewURL": "postgresql://sogo:sogo@127.0.0.1/sogo/sogo_users",
   "canAuthenticate": true,
   "isAddressBook": true
  }
 ],
 "SOGoCalendarDefaultRoles": ["PublicViewer"],
 "SOGoAppointmentSendEMailNotifications": true,
 "SOGoDraftsFolderName": "Drafts",
 "SOGoSentFolderName": "Sent",
 "SOGoTrashFolderName": "Trash",
 "SOGoMailShowSubscribedFoldersOnly": true,
 "SOGoEnableEMailAlarms": true
}
```


Create the SOGo PostgreSQL database:
```
sudo -u postgres psql
CREATE DATABASE sogo;
CREATE USER sogo WITH PASSWORD 'StrongPassword';
GRANT ALL PRIVILEGES ON DATABASE sogo TO sogo;
\q
```

âš™ï¸ Step 3 â€” Integrate with nginx
```
server {
  listen 443 ssl;
  server_name mail.yourdomain.com;

  ssl_certificate /etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/mail.yourdomain.com/privkey.pem;

  # Webmail
  location /SOGo {
    proxy_pass http://127.0.0.1:20000/SOGo;
    proxy_set_header Host $host;
    proxy_set_header x-webobjects-server-protocol https;
    proxy_set_header x-webobjects-remote-host $remote_addr;
    proxy_set_header x-webobjects-server-name $server_name;
  }

  # EAS endpoint
  location /Microsoft-Server-ActiveSync {
    proxy_pass http://127.0.0.1:20000/Microsoft-Server-ActiveSync;
    proxy_set_header Host $host;
    proxy_set_header x-webobjects-server-protocol https;
    proxy_set_header x-webobjects-remote-host $remote_addr;
    proxy_set_header x-webobjects-server-name $server_name;
  }

  # JMAP proxy (from previous setup)
  location /jmap {
    proxy_pass http://127.0.0.1:8080/jmap;
  }
}

âœ… Step 6 â€” Verify Everything
```
Feature	URL	Notes
Webmail	https://mail.yourdomain.com/SOGo
	Fully featured interface
EAS	https://mail.yourdomain.com/Microsoft-Server-ActiveSync
	iOS/Android/Outlook
CalDAV	https://mail.yourdomain.com/SOGo/dav/username/Calendar/personal/
	Any CalDAV client
CardDAV	https://mail.yourdomain.com/SOGo/dav/username/Contacts/personal/
	Contacts sync
JMAP	https://mail.yourdomain.com/jmap/
	Modern mail API
```


ğŸ§  Summary

âœ… What you get now:

IMAP + JMAP via Cyrus

SMTP (Postfix)

CalDAV + CardDAV + Webmail + EAS (SOGo)

Single domain or multi-domain capable

TLS secured reverse proxy (nginx)

Sieve filtering, public calendars, and address book sharing


```


postfix
```makefile
myhostname = mail.yourdomain.com
mydomain = yourdomain.com
myorigin = $mydomain
mydestination = localhost
relay_domains =
home_mailbox = Maildir/
smtpd_tls_cert_file=/etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
smtpd_tls_key_file=/etc/letsencrypt/live/mail.yourdomain.com/privkey.pem
smtpd_use_tls=yes
smtpd_sasl_auth_enable=yes
smtpd_sasl_type = cyrus
smtpd_sasl_path = smtpd
smtpd_sasl_security_options = noanonymous
smtpd_recipient_restrictions =
  permit_sasl_authenticated,
  permit_mynetworks,
  reject_unauth_destination

```

imapd.conf
```
configdirectory: /var/lib/cyrus
defaultpartition: default
partition-default: /var/spool/cyrus/mail
admins: cyrus
sievedir: /var/lib/cyrus/sieve
lmtpsocket: /var/run/cyrus/socket/lmtp
idlesocket: /var/run/cyrus/socket/idle
notifysocket: /var/run/cyrus/socket/notify
allowplaintext: yes
sasl_pwcheck_method: saslauthd
sasl_mech_list: PLAIN LOGIN
tls_cert_file: /etc/letsencrypt/live/mail.yourdomain.com/fullchain.pem
tls_key_file: /etc/letsencrypt/live/mail.yourdomain.com/privkey.pem
httpmodules: jmap caldav carddav
httpallowcompress: 1
httpallowplaintext: no
```

cyrus.conf
```
SERVICES {
 imap   cmd="imapd" listen="imap" prefork=0
 imaps   cmd="imapd -s" listen="imaps" prefork=0
 lmtp   cmd="lmtpd" listen="lmtp" prefork=0
 sieve   cmd="timsieved" listen="sieve" prefork=0
 http   cmd="httpd" listen="localhost:8080" prefork=0
}

```

## Requirements
- multi domains, alias
- Address book, CardDAV
- Calendar, iCal, calDAV (personal, internal, public holidays)
- Contacts, vCard, vCardDAV

## Architecture
- DNS (MX, SPF, DKIM, DMARC)
- MTA
- IMAP, SMTP
- Webmail (Mailcow, Modoboa)
- Amavis, ClamAV, SpamAssassin
- Mail message queue
- Storage
- audit, log, alert
- Mailbox management
- User authentication and authorization
- Email delivery and routing
- Email filtering and processing
- Email archiving and retention policies
- Email spam filtering and protection
- Email encryption and security features
- Email integration with other applications and services

## Features
- Multi-domain email hosting
- Email forwarding and aliasing
- Address book and contact management
- Calendar and event scheduling
- Email notifications and alerts
- Email archiving and retention policies
- Email spam filtering and protection
- Email encryption and security features
- Email integration with other applications and services

## Implementation
- Backend: Django, PostgreSQL
- Frontend: React, Redux
- Email server: Postfix, Dovecot
- Webmail: Roundcube, Rainloop

## Security
- SSL/TLS encryption for all communication channels
- Two-factor authentication for user accounts
- Rate limiting and IP blocking for suspicious activity
- Regular security audits and penetration testing
- Compliance with industry standards and regulations (e.g., GDPR, HIPAA)

## Compliance
- GDPR compliance for data protection and privacy
- HIPAA compliance for healthcare data security and privacy
- SOC 2 compliance for service organization control
- PCI DSS compliance for payment card industry data security
- SOC 3 compliance for service organization control
- ISO 27001 compliance for information security management system
- ISO 27017 compliance for cloud security
- ISO 27018 compliance for cloud privacy
- ISO 27701 compliance for privacy management system
- ISO 27021 compliance for cloud security
- ISO 27022 compliance for cloud security

## Management
- User and Quota
- Domains and aliases
- Monitoring and logging
- Security and compliance
